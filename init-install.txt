# Load keyboard layout
# loadkeys de

# Connect to WLAN (if not LAN)
# iwctl --passphrase 22036727328731084417 station wlan0 connect WLAN-381152

# Install git
# pacman -S git

# Clone archinstall
git clone https://gitlab.com/stephan.raabe/archinstall.git

# Check internet connection
# ping -c4 www.google.de

# Sync time
timedatectl set-ntp true

# Reflector setup
reflector -c Germany -a 6 --sort rate --save /etc/pacman.d/mirrorlist

# Pacman sync
pacman -Syy

# Check partitions
lsblk

# Create partitions
gdisk /dev/sda
1: +512M ef00
c: BOOT
2: Rest 8300
c: ROOT
Write: w, Confirm with Y

# Format partitions
mkfs.vfat -n BOOT /dev/sda1
mkfs.btrfs -L ROOT /dev/sda3

# Mount points for btrfs
mount /dev/sda3 /mnt
btrfs su cr /mnt/@
btrfs su cr /mnt/@cache
btrfs su cr /mnt/@home
btrfs su cr /mns/@images
btrfs su cr /mnt/@snapshots
btrfs su cr /mnt/@log
umount /mnt

mount -o compress=zstd:1,noatime,subvol=@ /dev/sda2 /mnt
mkdir -p /mnt/{boot/efi,home,.snapshots,var/{cache,log,lib/libvirt/images}}

mount -o compress=zstd:1,noatime,subvol=@cache /dev/sda2 /mnt/var/cache
mount -o compress=zstd:1,noatime,subvol=@home /dev/sda2 /mnt/home
mount -o compress=zstd:1,noatime,subvol=@images /dev/sda2 /mnt/var/lib/libvirt/images
mount -o compress=zstd:1,noatime,subvol=@log /dev/sda2 /mnt/var/log
mount -o compress=zstd:1,noatime,subvol=@snapshots /dev/sda2 /mnt/.snapshots

mount /dev/sda1 /mnt/boot/efi

# Install base packages
pacstrap -K /mnt base base-devel git linux linux-firmware vim openssh reflector rsync amd-ucode

# Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab

# Enter the Arch install directory
arch-chroot /mnt

# Clone archinstall
git clone https://gitlab.com/stephan.raabe/archinstall.git

# Add btrfs to mkinitcpio
vim /etc/mkinitcpio.conf
BINARIES=(btrfs)
mkinitcpio -p linux

# Install Snapper Support
yay -S snapper-support
sudo -s
cd /
umount /.snapshots
rm -r /.snapshots
snapper -c root create-config /
btrfs subvol list /
btrfs subvolume delete /.snapshots
mkdir /.snapshots
mount -a
btrfs subvol get-default /
btrfs subvol list /
btrfs subvol set-def 256 /
btrfs subvol get-default /
snapper ls

# Edit Snapper Config
vim /etc/snapper/configs/root
ALLOW_GROUPS="wheel"
TIMELINE_CREATE="no"
5,5,0,0,0
chown -R :wheel /.snapshots
exit
snapper ls

# Create first snapshot
sudo -s
cd /
snapper -c root create -d "*** System installed ***"
snapper ls
systemctl status grub-btrfs-snapper.service
exit

# Install zram
yay -S zram-generator
sudo vim /etc/systemd/zram-generator.conf
Add
[zram0]
zram-size = ram / 2

sudo systemctl daemon-reload
sudo systemctl start /dev/zram0
reboot
free -h

# Install duf
yay -S duf
duf

# Rollback
sudo -s
snapper ls
mount -t btrfs -o subvol=/ /dev/sda2 /mnt
cd /mnt
ls
cd @
ls
rm -fr *
btrfs subvolume delete /mnt/@

btrfs subvolume snapshot /mnt/@snapshots/1/snapshot /mnt/@
umount /mnt



exit
umount -a
reboot

