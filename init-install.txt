# Load keyboard layout
loadkeys de

# Connect to WLAN (if not LAN)
iwctl --passphrase 22036727328731084417 station wlan0 connect WLAN-381152

# Check internet connection
ping -c4 www.google.de

# Sync time
timedatectl set-ntp true

# Reflector setup
reflector -c Germany -a 6 --sort rate --save /etc/pacman.d/mirrorlist

# Pacman sync
pacman -Syy

# Check partitions
lsblk

# Create partitions
gdisk /dev/sda
1: +300M ef00
2: +2G 8200
3: Rest 8300
Write: w, Confirm with Y

# Format partitions
mkfs.fat -F32 /dev/sda1
mkswap /dev/sda2
swapon /dev/sda2
mkfs.btrfs /dev/sda3

# Mount points for btrfs
mount /dev/sda3 /mnt
btrfs su cr /mnt/@
btrfs su cr /mnt/@home
btrfs su cr /mnt/@snapshots
btrfs su cr /mnt/@var_log
umount /mnt
mount -o noatime,compress=lzo,space_cache=v2,subvol=@ /dev/sda3 /mnt
mkdir -p /mnt/{boot,home,.snapshots,var_log}
mount -o noatime,compress=lzo,space_cache=v2,subvol=@home /dev/sda3 /mnt/home
mount -o noatime,compress=lzo,space_cache=v2,subvol=@snapshots /dev/sda3 /mnt/.snapshots
mount -o noatime,compress=lzo,space_cache=v2,subvol=@var_log /dev/sda3 /mnt/var_log
mount /dev/sda1 /mnt/boot

# Install base packages
pacstrap /mnt base linux linux-firmware vim amd-ucode

# Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab

# Enter the Arch install directory
arch-chroot /mnt

# Clone archinstall
git clone https://gitlab.com/stephan.raabe/archinstall.git

# Add btrfs to mkinitcpio
vim /etc/mkinitcpio.conf
MODULES=(btrfs)
mkinitcpio -p linux

# Install grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --removable
grub-mkconfig -o /boot/grub/grub.cfg

sudo vim /etc/sudoers

exit
umount -a
reboot

