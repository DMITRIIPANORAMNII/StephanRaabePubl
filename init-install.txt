# Load keyboard layout
loadkeys de

# Connect to WLAN (if not LAN)
iwctl --passphrase 22036727328731084417 station wlan0 connect WLAN-381152

# Check internet connection
ping -c4 www.google.de

# Sync time
timedatectl set-ntp true

# Reflector setup
reflector -c Germany -a 6 --sort rate --save /etc/pacman.d/mirrorlist

# Pacman sync
pacman -Syy

# Check partitions
lsblk

# Create partitions
gdisk /dev/sda
1: +512M ef00
c: BOOT
2: Rest 8300
c: ROOT
Write: w, Confirm with Y

# Format partitions
mkfs.vfat -n BOOT /dev/sda1
mkfs.btrfs -L ROOT /dev/sda3

# Mount points for btrfs
mount /dev/sda3 /mnt
btrfs su cr /mnt/@
btrfs su cr /mnt/@cache
btrfs su cr /mnt/@home
btrfs su cr /mns/@images
btrfs su cr /mnt/@snapshots
btrfs su cr /mnt/@log
umount /mnt

mount -o compress=zstd:1,noatime,subvol=@ /dev/sda2 /mnt
mkdir -p /mnt/{boot/efi,home,.snapshots,var/{cache,log,lib/libvirt/images}}

mount -o compress=zstd:1,noatime,subvol=@cache /dev/sda2 /mnt/var/cache
mount -o compress=zstd:1,noatime,subvol=@home /dev/sda2 /mnt/home
mount -o compress=zstd:1,noatime,subvol=@images /dev/sda2 /mnt/var/lib/libvirt/images
mount -o compress=zstd:1,noatime,subvol=@log /dev/sda2 /mnt/var/log
mount -o compress=zstd:1,noatime,subvol=@snapshots /dev/sda2 /mnt/.snapshots

mount /dev/sda1 /mnt/boot/efi

# Install base packages
pacstrap -K /mnt base base-devel git linux linux-firmware vim openssh reflector rsync amd-ucode

# Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab

# Enter the Arch install directory
arch-chroot /mnt

# Clone archinstall
git clone https://gitlab.com/stephan.raabe/archinstall.git

# Add btrfs to mkinitcpio
vim /etc/mkinitcpio.conf
MODULES=(btrfs)
mkinitcpio -p linux

# Install grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --removable
grub-mkconfig -o /boot/grub/grub.cfg

sudo vim /etc/sudoers

exit
umount -a
reboot

